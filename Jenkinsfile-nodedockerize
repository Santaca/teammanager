pipeline {
    agent {
        label 'docker-agent'
    }

    environment {
        ECR_URI = "${ECR_URI}"
        REGION = "eu-west-3"
        IMAGE_NAME = 'unir/teammanager'
    }

    stages {
        stage('Source') {
            steps {
                git "https://github.com/Santaca/teammanager"
            }
        }
        stage('Build image') {
            steps {
                script {
                    dockerImage = docker.build '${IMAGE_NAME}' 
                }
            }
        }
        stage('Push image') {
            steps {
                script {
                    sh 'aws ecr get-login-password --region ${REGION} | docker login --username AWS --password-stdin ${ECR_URI}'
                    sh 'docker push ${IMAGE_NAME}'
                }
            }
        }
    }

}